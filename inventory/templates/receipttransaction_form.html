{% extends 'layout.html' %}
{% load static %}
{% block title %}GRN Form - ERP System{% endblock %}
{% block content %}
<div class="container">
  <h2 class="page-title">GRN Form</h2>
  <div class="form-container" style="max-height: 70vh; overflow-y: auto; padding-right: 15px;">
    <form method="post" novalidate>
      {% csrf_token %}
      {% if message %}
      <div class="alert alert-success">{{ message|striptags }}</div>
      {% endif %}
      {% if errors %}
      <div class="alert alert-danger">{{ errors|striptags }}</div>
      {% endif %}
      {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors|striptags }}
      </div>
      {% endif %}
      {% for field in form %}
      <div class="form-group">
        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          {{ field }}
          {% if field.name == 'area' or field.name == 'po' or field.name == 'item' %}
          <button type="button" class="btn btn-primary btn-sm" onclick="openLookup('{{ field.name }}')">
            <i class="fa fa-search"></i> Search
          </button>
          {% endif %}
        </div>
        {% if field.errors %}
        <div class="text-danger">{{ field.errors|striptags }}</div>
        {% endif %}
      </div>
      {% endfor %}
      <button type="submit" class="submit-button"><i class="fas fa-check-circle"></i> Submit</button>
    </form>
  </div>
</div>

<!-- Lookup Modal -->
<div id="lookupModal" class="modal" style="display: none;">
  <div class="modal-content" style="width: 80%; max-width: 800px;">
    <div class="modal-header">
      <h3 id="modalTitle">Search</h3>
      <span class="close" onclick="closeLookup()">&times;</span>
    </div>
    <div class="modal-body">
      <input type="text" id="searchInput" class="form-control" placeholder="Type to search..." onkeyup="filterTable()">
      <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
        <table class="table" id="lookupTable">
          <thead>
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 0;
  border: 1px solid #888;
  border-radius: 8px;
}

.modal-header {
  padding: 15px;
  background-color: #007bff;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 8px 8px 0 0;
}

.modal-body {
  padding: 20px;
}

.close {
  color: white;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: #ddd;
}

.table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.table th, .table td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.table th {
  background-color: #f8f9fa;
  font-weight: bold;
}

.table tbody tr:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}
</style>

<script>
let currentField = '';
let allData = [];

function openLookup(fieldName) {
  currentField = fieldName;
  document.getElementById('lookupModal').style.display = 'block';
  document.getElementById('searchInput').value = '';
  
  if (fieldName === 'area') {
    document.getElementById('modalTitle').textContent = 'Search Area';
    fetch('/inventory/lookup_area/')
      .then(response => response.json())
      .then(data => {
        allData = data;
        displayTable(data, ['id', 'areacode', 'areaname', 'area_description']);
      })
      .catch(err => console.error('Error fetching areas:', err));
  } else if (fieldName === 'po') {
    document.getElementById('modalTitle').textContent = 'Search PO';
    fetch('/inventory/lookup_po/')
      .then(response => response.json())
      .then(data => {
        allData = data;
        displayTable(data, ['id', 'po_number', 'supplier', 'po_date']);
      })
      .catch(err => console.error('Error fetching POs:', err));
  } else if (fieldName === 'item') {
    document.getElementById('modalTitle').textContent = 'Search Item';
    fetch('/inventory/lookup_item/')
      .then(response => response.json())
      .then(data => {
        allData = data;
        displayTable(data, ['id', 'item_code', 'item_description', 'category']);
      })
      .catch(err => console.error('Error fetching items:', err));
  }
}

function closeLookup() {
  document.getElementById('lookupModal').style.display = 'none';
}

function displayTable(data, columns) {
  const headerRow = document.getElementById('tableHeader');
  const tbody = document.getElementById('tableBody');
  
  headerRow.innerHTML = '';
  tbody.innerHTML = '';
  
  // Create headers
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.replace('_', ' ').toUpperCase();
    headerRow.appendChild(th);
  });
  
  // Create rows
  data.forEach(item => {
    const tr = document.createElement('tr');
    tr.onclick = () => selectItem(item.id);
    
    columns.forEach(col => {
      const td = document.createElement('td');
      td.textContent = item[col] || '';
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

function selectItem(id) {
  const selectElement = document.querySelector(`select[name="${currentField}"]`);
  if (selectElement) {
    selectElement.value = id;
  }
  closeLookup();
}

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  const filteredData = allData.filter(item => {
    return Object.values(item).some(val => 
      String(val).toLowerCase().includes(searchTerm)
    );
  });
  
  if (currentField === 'area') {
    displayTable(filteredData, ['id', 'areacode', 'areaname', 'area_description']);
  } else if (currentField === 'po') {
    displayTable(filteredData, ['id', 'po_number', 'supplier', 'po_date']);
  } else if (currentField === 'item') {
    displayTable(filteredData, ['id', 'item_code', 'item_description', 'category']);
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('lookupModal');
  if (event.target == modal) {
    closeLookup();
  }
}
</script>
{% endblock %}
